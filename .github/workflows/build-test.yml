name: Build & Test

on:
  push:
    branches:
      - master
      - main
      - develop
  pull_request:
    branches:
      - master
      - main
      - develop

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          MSSQL_SA_PASSWORD: TestPassword123!
          ACCEPT_EULA: Y
        options: >-
          --health-cmd="/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P TestPassword123! -Q 'SELECT 1'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 1433:1433

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup .NET 10
      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      # 3. Restore NuGet packages
      - name: Restore NuGet packages
        run: dotnet restore

      # 4. Build solution
      - name: Build solution
        run: dotnet build --configuration Release --no-restore

      # 5. Wait for SQL Server to be ready
      - name: Wait for SQL Server
        run: |
          echo "Waiting for SQL Server to be ready..."
          for i in {1..30}; do
            if sqlcmd -S localhost -U sa -P "TestPassword123!" -Q "SELECT 1" &> /dev/null; then
              echo "SQL Server is ready!"
              break
            fi
            echo "Attempt $i/30... Waiting for SQL Server"
            sleep 2
          done
        continue-on-error: true

      # 6. Create test database
      - name: Create test database
        run: |
          sqlcmd -S localhost -U sa -P "TestPassword123!" \
            -Q "CREATE DATABASE IF NOT EXISTS ErpDocuments_Test"
        continue-on-error: true

      # 7. Run unit and integration tests
      - name: Run tests
        run: dotnet test --configuration Release --no-build --verbosity normal
        env:
          ConnectionStrings__DefaultConnection: "Server=localhost;Database=ErpDocuments_Test;User Id=sa;Password=TestPassword123!;TrustServerCertificate=true;"
          ASPNETCORE_ENVIRONMENT: "Testing"
        continue-on-error: true

      # 8. Display build info
      - name: Display build info
        if: always()
        run: |
          echo "=== Build Summary ==="
          echo "Status: Completed"
          echo "Configuration: Release"
          echo "Target Framework: .NET 10"
          dotnet --version
        continue-on-error: true

          
          docker rm -f erp-api-test || true
        continue-on-error: true
